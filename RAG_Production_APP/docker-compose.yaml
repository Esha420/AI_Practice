services:
  fastapi:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rag_fastapi
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      INNGEST_DEV_HOST: "http://inngest:8288"
      QDRANT_URL: "http://qdrant:6333"
      REDIS_URL: "redis://redis:6379"
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      inngest:
        condition: service_started  # Changed to started instead of healthy
    networks:
      - rag_network

  streamlit:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rag_streamlit
    ports:
      - "8501:8501"
    env_file:
      - .env
    depends_on:
      - fastapi
    networks:
      - rag_network

  inngest:
    image: inngest/inngest:v1.14.0
    container_name: rag_inngest
    ports:
      - "8288:8288"
    command: ["inngest", "dev", "--host", "0.0.0.0", "--port", "8288"]
    environment:
      INNGEST_SIGNING_KEY: "${INNGEST_SIGNING_KEY:-test-key}"
      INNGEST_EVENT_KEY: "${INNGEST_EVENT_KEY:-test-key}"
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 2 bash -c '</dev/tcp/localhost/8288' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - rag_network

  qdrant:
    image: qdrant/qdrant:latest
    restart: always
    container_name: rag_qdrant
    ports:
      - 6333:6333
      - 6334:6334
    volumes:
      - ./qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 2 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s  # Give more time for qdrant to start
    networks:
      - rag_network

  redis:
    image: redis:7
    container_name: rag_redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 2s
      retries: 12
    networks:
      - rag_network

networks:
  rag_network:
    driver: bridge

volumes:
  qdrant_storage:
